/**
 * è‚¡ç¥¨ç­›é€‰å™¨ - é‡æ„ç‰ˆ
 * ä½¿ç”¨æ–°çš„è‡ªå®šä¹‰ Hooks ç®€åŒ–ä»£ç 
 * 
 * é‡æ„ç›®æ ‡ï¼š
 * 1. ä½¿ç”¨ useFilterConfig ç®¡ç†ç­›é€‰é…ç½®
 * 2. ä½¿ç”¨ useUIState ç®¡ç† UI çŠ¶æ€
 * 3. ä½¿ç”¨ useDisplayState ç®¡ç†é¢æ¿æ˜¾ç¤º
 * 4. ä½¿ç”¨ useStockScreening ç®¡ç†ç­›é€‰é€»è¾‘
 * 5. å‡å°‘ä»£ç é‡ï¼Œæé«˜å¯ç»´æŠ¤æ€§
 */
import { useEffect, useRef } from 'react';
import { 
  screenStocks, 
  screenBandTradingStocks, 
  filterStocks, 
  createCancelToken, 
  updateMarginStocks 
} from './api/stock';
import type { ScreenedStock } from './api/stock';
import { 
  useFilterConfig, 
  useUIState, 
  useDisplayState, 
  useStockScreening 
} from './hooks';

// ç»„ä»¶å¯¼å…¥
import AIRadar from './components/AIRadar';
import StockCard from './components/StockCard';
import FilterPanel from './components/FilterPanel';
import FinalPickCard from './components/FinalPickCard';
import MarketEnvironmentComponent from './components/MarketEnvironment';
import FavoritesPanel from './components/FavoritesPanel';
import QuickFilters from './components/QuickFilters';
import StockComparison from './components/StockComparison';
import AlertCenter from './components/AlertCenter';
import AddAlertDialog from './components/AddAlertDialog';
import PortfolioTracker from './components/PortfolioTracker';
import AddPositionDialog from './components/AddPositionDialog';
import EditPositionDialog from './components/EditPositionDialog';

// å·¥å…·å‡½æ•°
import { 
  addHistory, 
  getHistory, 
  deleteHistoryItem, 
  clearHistory 
} from './utils/localStorage';
import { 
  getCachedScreenResult, 
  setCachedScreenResult 
} from './utils/localStorage';
import { 
  getBoardHistory, 
  addBoardHistory 
} from './utils/localStorage';
import { 
  addTrackingRecord
} from './utils/localStorage';
import { 
  addMarketEmotion
} from './utils/localStorage';
import { 
  generateTradingPlan, 
  saveTradingPlans 
} from './utils/localStorage';

// æœåŠ¡
import { AlertManager } from './services/AlertManager';
import { NotificationService } from './services/NotificationService';
import { PortfolioManager } from './services/PortfolioManager';

import './App.css';

// =============================================================================
// å·¥å…·å‡½æ•°
// =============================================================================

/**
 * æ ¼å¼åŒ–é‡‘é¢
 */
const formatAmount = (amount: number): string => {
  if (amount >= 100000000) {
    return (amount / 100000000).toFixed(2) + 'äº¿';
  } else if (amount >= 10000) {
    return (amount / 10000).toFixed(2) + 'ä¸‡';
  }
  return amount.toFixed(2);
};

/**
 * åˆ¤æ–­ç­–ç•¥ç±»å‹
 */
const getStrategyType = (changeMin: number, changeMax: number): string => {
  if (changeMin >= 2 && changeMax >= 6) {
    return 'aggressive';
  } else if (changeMax <= 2 && changeMin <= 0) {
    return 'conservative';
  }
  return 'balanced';
};

/**
 * è®¡ç®—å¸‚åœºæƒ…ç»ª
 */
const calculateMarketEmotion = (stocks: ScreenedStock[]) => {
  const riseCount = stocks.filter(s => s.change_percent > 0).length;
  const fallCount = stocks.length - riseCount;
  const riseRatio = riseCount / stocks.length;
  const avgChange = stocks.reduce((sum, s) => sum + s.change_percent, 0) / stocks.length;
  const avgRatio = stocks.reduce((sum, s) => sum + s.volume_ratio, 0) / stocks.length;
  
  const emotionScore = Math.round(
    riseRatio * 40 +
    Math.min(avgChange / 5 * 30, 30) +
    Math.min(avgRatio / 3 * 20, 20) +
    10
  );
  
  let emotionLevel: string;
  let suggestion: string;
  
  if (emotionScore < 20) {
    emotionLevel = 'panic_extreme';
    suggestion = 'ğŸŸ¢ æåº¦ææ…Œï¼Œé‡ä»“æœºä¼šï¼';
  } else if (emotionScore < 40) {
    emotionLevel = 'panic';
    suggestion = 'ğŸŸ¢ å¸‚åœºææ…Œï¼Œæ­£å¸¸å»ºä»“ã€‚';
  } else if (emotionScore < 60) {
    emotionLevel = 'neutral';
    suggestion = 'ğŸŸ¡ å¸‚åœºä¸­æ€§ï¼Œè°¨æ…æ“ä½œã€‚';
  } else if (emotionScore < 80) {
    emotionLevel = 'optimistic';
    suggestion = 'ğŸŸ  å¸‚åœºä¹è§‚ï¼Œå»ºè®®å‡ä»“ã€‚';
  } else {
    emotionLevel = 'optimistic_extreme';
    suggestion = 'ğŸ”´ æåº¦ä¹è§‚ï¼Œç©ºä»“é¿é™©ï¼';
  }
  
  return {
    score: emotionScore,
    level: emotionLevel,
    riseCount,
    fallCount,
    riseRatio,
    avgChange,
    avgRatio,
    suggestion
  };
};

// =============================================================================
// ä¸»ç»„ä»¶
// =============================================================================

function App() {
  // ä½¿ç”¨æ–°çš„ Hooks
  const filter = useFilterConfig();
  const ui = useUIState();
  const display = useDisplayState();
  const screening = useStockScreening({ cacheExpiry: ui.cacheExpiry });
  
  // Refs
  const cancelTokenSource = useRef<any>(null);
  const alertManagerRef = useRef<AlertManager | null>(null);
  const notificationServiceRef = useRef<NotificationService | null>(null);
  const portfolioManagerRef = useRef<PortfolioManager | null>(null);

  // =============================================================================
  // åˆå§‹åŒ–
  // =============================================================================
  
  useEffect(() => {
    // åˆå§‹åŒ–æé†’ç®¡ç†å™¨
    alertManagerRef.current = new AlertManager();
    notificationServiceRef.current = new NotificationService();
    portfolioManagerRef.current = new PortfolioManager();
    
    // åº”ç”¨ä¸»é¢˜
    document.documentElement.setAttribute('data-theme', ui.theme);
    document.body.className = ui.theme === 'dark' ? 'dark-theme' : '';
  }, [ui.theme]);
  
  // =============================================================================
  // äº‹ä»¶å¤„ç†
  // =============================================================================
  
  /**
   * æ›´æ–°èèµ„èåˆ¸æ•°æ®
   */
  const handleUpdateMargin = async () => {
    try {
      const result = await updateMarginStocks();
      alert(`âœ… æ›´æ–°æˆåŠŸï¼\n${result.message}`);
    } catch (err: any) {
      alert(`âŒ æ›´æ–°å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}`);
    }
  };
  
  /**
   * æ‰§è¡Œç­›é€‰
   */
  const handleScreen = async () => {
    screening.setError(null);
    screening.setProgress('æ­£åœ¨è·å–å…¨å¸‚åœºæ•°æ®...');
    
    // æ£€æŸ¥ç¼“å­˜
    const cached = getCachedScreenResult(filter.filterConfig, ui.cacheExpiry);
    if (cached) {
      screening.setScreenedStocks(cached.stocks);
      if (cached.marketEnv) {
        screening.setMarketEnv(cached.marketEnv);
      }
      return;
    }
    
    try {
      let result;
      
      if (filter.filterConfig.isBandTradingMode) {
        const strategyType = getStrategyType(
          filter.filterConfig.changeMin,
          filter.filterConfig.changeMax
        );
        
        result = await screenBandTradingStocks({
          change_min: filter.filterConfig.changeMin,
          change_max: filter.filterConfig.changeMax,
          volume_ratio_min: filter.filterConfig.volumeRatioMin,
          volume_ratio_max: filter.filterConfig.volumeRatioMax,
          market_cap_max: filter.filterConfig.marketCapMax,
          limit: 3,
          strategy_type: strategyType,
        });
      } else {
        result = await screenStocks({
          change_min: filter.filterConfig.changeMin,
          change_max: filter.filterConfig.changeMax,
          volume_ratio_min: filter.filterConfig.volumeRatioMin,
          volume_ratio_max: filter.filterConfig.volumeRatioMax,
          market_cap_min: filter.filterConfig.marketCapMin,
          market_cap_max: filter.filterConfig.marketCapMax,
          limit: 30,
          include_cyb: filter.filterConfig.includeKcbCyb,
          require_margin: filter.filterConfig.requireMargin,
        });
      }
      
      screening.setScreenedStocks(result.data);
      
      if (result.market_environment) {
        screening.setMarketEnv(result.market_environment);
      }
      
      // ä¿å­˜åˆ°ç¼“å­˜
      setCachedScreenResult(filter.filterConfig, result.data, result.market_environment, ui.cacheExpiry);
      
      // æ·»åŠ åˆ°å†å²è®°å½•
      addHistory(filter.filterConfig, result.data.length, result.market_environment);
      
      // ä¿å­˜æ¿å—å†å²
      if (result.data.length > 0) {
        const boardCounts = result.data.reduce((acc: any, stock: any) => {
          const boardType = stock.board_type?.type || 'unknown';
          acc[boardType] = (acc[boardType] || 0) + 1;
          return acc;
        }, {});
        
        const industryCounts = result.data.reduce((acc: any, stock: any) => {
          const industry = stock.industry || 'æœªçŸ¥';
          acc[industry] = (acc[industry] || 0) + 1;
          return acc;
        }, {});
        
        const avgChange = result.data.reduce((sum: number, s: any) => sum + s.change_percent, 0) / result.data.length;
        const avgRatio = result.data.reduce((sum: number, s: any) => sum + s.volume_ratio, 0) / result.data.length;
        
        addBoardHistory({
          boardDistribution: {
            sh_count: boardCounts.sh || 0,
            sz_count: boardCounts.sz || 0,
            cyb_count: boardCounts.cyb || 0
          },
          industryDistribution: industryCounts,
          avgChange,
          avgRatio
        });
        
        // æ·»åŠ å†å²è¿½è¸ª
        addTrackingRecord(result.data);
        
        // è®¡ç®—å¸‚åœºæƒ…ç»ª
        const emotion = calculateMarketEmotion(result.data);
        addMarketEmotion(emotion);
        
        // ç”Ÿæˆäº¤æ˜“è®¡åˆ’
        const plans = result.data.map((stock: any) => generateTradingPlan(stock));
        screening.setTradingPlans(plans);
        saveTradingPlans(plans);
      }
      
      screening.setState('screened');
    } catch (err: any) {
      screening.setError(err.response?.data?.detail || 'ç­›é€‰å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      screening.setState('idle');
    } finally {
      screening.setProgress('');
    }
  };
  
  /**
   * æ‰§è¡Œè¿‡æ»¤ç²¾é€‰
   */
  const handleFilter = async () => {
    if (screening.screenedStocks.length === 0) return;
    
    screening.setState('filtering');
    screening.setError(null);
    screening.setProgress('æ­£åœ¨åˆå§‹åŒ–åˆ†æ...');
    
    // åˆ›å»ºå–æ¶ˆä»¤ç‰Œ
    cancelTokenSource.current = createCancelToken();
    
    // è¿›åº¦æç¤º
    const tips = [
      'æ­£åœ¨è·å–å®æ—¶è¡Œæƒ…æ•°æ®...',
      'æ­£åœ¨åˆ†æKçº¿èµ°åŠ¿...',
      'æ­£åœ¨è®¡ç®—èµ„é‡‘æµå‘...',
      'æ­£åœ¨æ£€æµ‹æŠ€æœ¯æŒ‡æ ‡...',
      'æ­£åœ¨è¯„ä¼°é£é™©å› ç´ ...',
      'æ­£åœ¨è¿›è¡ŒAIç»¼åˆè¯„åˆ†...',
      'æ­£åœ¨ç”Ÿæˆäº¤æ˜“è®¡åˆ’...',
      'å³å°†å®Œæˆåˆ†æ...',
    ];
    let tipIndex = 0;
    
    const progressTimer = setInterval(() => {
      screening.setProgress(tips[Math.min(tipIndex++, tips.length - 1)]);
    }, 8000);
    
    try {
      const codes = screening.screenedStocks.map(s => s.code);
      const result = await filterStocks(
        codes,
        filter.filterConfig.includeKcbCyb,
        filter.filterConfig.preferTailInflow,
        filter.filterConfig.strictRiskControl,
        cancelTokenSource.current.token
      );
      
      clearInterval(progressTimer);
      
      screening.setFilteredStocks(result.data);
      screening.setAnalysisResults(result.all_analysis);
      screening.setAiSelectedStocks(result.ai_selected || []);
      screening.setMarketEnv(result.market_environment || null);
      screening.setFinalPick(result.final_pick || null);
      screening.setFinalPicks(result.final_picks || []);
      screening.setSelectedPickIndex(0);
      display.setShowFinalPick(false);
      display.setIsScreenedCollapsed(true);
      screening.setState('filtered');
    } catch (err: any) {
      clearInterval(progressTimer);
      
      if (err.message === 'Cancel') {
        screening.setError('åˆ†æå·²å–æ¶ˆ');
      } else {
        screening.setError(err.response?.data?.detail || 'è¿‡æ»¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
      screening.setState('screened');
    } finally {
      screening.setProgress('');
    }
  };
  
  /**
   * å–æ¶ˆè¿‡æ»¤
   */
  const handleCancelFilter = () => {
    if (cancelTokenSource.current) {
      cancelTokenSource.current.cancel('Cancel');
      screening.setProgress('');
      screening.setState('screened');
    }
  };
  
  /**
   * é‡ç½®
   */
  const handleReset = () => {
    screening.clearResults();
    display.setIsScreenedCollapsed(false);
  };
  
  // =============================================================================
  // æ¸²æŸ“
  // =============================================================================
  
  return (
    <div className={`app theme-${ui.theme}`}>
      {/* å¤´éƒ¨ */}
      <header className="app-header">
        <h1>ğŸ“Š Aè‚¡æ³¢æ®µäº¤æ˜“ç­›é€‰ç³»ç»Ÿ</h1>
        <div className="header-actions">
          <button onClick={ui.toggleThemeMode}>
            {ui.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'}
          </button>
          <button onClick={() => ui.setShowSettings(true)}>
            âš™ï¸ è®¾ç½®
          </button>
        </div>
      </header>
      
      {/* ç­›é€‰é¢æ¿ */}
      <FilterPanel
        config={filter.filterConfig}
        onChangeMinChange={filter.setChangeMin}
        onChangeMaxChange={filter.setChangeMax}
        onVolumeRatioMinChange={filter.setVolumeRatioMin}
        onVolumeRatioMaxChange={filter.setVolumeRatioMax}
        onMarketCapMinChange={filter.setMarketCapMin}
        onMarketCapMaxChange={filter.setMarketCapMax}
        onIncludeKcbCybChange={filter.setIncludeKcbCyb}
        onPreferTailInflowChange={filter.setPreferTailInflow}
        onStrictRiskControlChange={filter.setStrictRiskControl}
        onIsBandTradingModeChange={filter.setIsBandTradingMode}
      />
      
      {/* æ“ä½œæŒ‰é’® */}
      <div className="action-buttons">
        <button 
          onClick={handleScreen}
          disabled={screening.state === 'screening'}
          className="primary-button"
        >
          {screening.state === 'screening' ? 'ç­›é€‰ä¸­...' : 'å¼€å§‹ç­›é€‰'}
        </button>
        
        {screening.state === 'screened' && (
          <button onClick={handleFilter} className="secondary-button">
            ç²¾é€‰è¿‡æ»¤
          </button>
        )}
        
        {screening.state === 'filtering' && (
          <button onClick={handleCancelFilter} className="danger-button">
            å–æ¶ˆåˆ†æ
          </button>
        )}
        
        <button onClick={handleReset} className="text-button">
          é‡ç½®
        </button>
      </div>
      
      {/* è¿›åº¦æ˜¾ç¤º */}
      {screening.progress && (
        <div className="progress-bar">
          <div className="progress-spinner" />
          <span>{screening.progress}</span>
        </div>
      )}
      
      {/* é”™è¯¯æç¤º */}
      {screening.error && (
        <div className="error-message">
          âŒ {screening.error}
        </div>
      )}
      
      {/* å¸‚åœºç¯å¢ƒ */}
      {screening.marketEnv && (
        <MarketEnvironmentComponent data={screening.marketEnv} />
      )}
      
      {/* ç­›é€‰ç»“æœ */}
      {screening.state !== 'idle' && screening.screenedStocks.length > 0 && (
        <section className="results-section">
          <h2>
            ç­›é€‰ç»“æœ 
            <span className="count">({screening.screenedStocks.length}åª)</span>
          </h2>
          
          <div className="stock-grid">
            {screening.screenedStocks.map(stock => (
              <StockCard key={stock.code} stock={stock} />
            ))}
          </div>
        </section>
      )}
      
      {/* ç²¾é€‰ç»“æœ */}
      {screening.finalPicks.length > 0 && (
        <section className="final-picks-section">
          <h2>ç²¾é€‰æ¨è</h2>
          <div className="final-picks-grid">
            {screening.finalPicks.map((pick, index) => (
              <FinalPickCard
                key={pick.code}
                pick={pick}
                isSelected={index === screening.selectedPickIndex}
                onClick={() => screening.setSelectedPickIndex(index)}
              />
            ))}
          </div>
        </section>
      )}
      
      {/* é¢æ¿ç»„ä»¶ */}
      {display.showFavorites && (
        <FavoritesPanel onClose={() => display.setShowFavorites(false)} />
      )}
      
      {display.showComparison && (
        <StockComparison onClose={() => display.setShowComparison(false)} />
      )}
      
      {display.showAlertCenter && (
        <AlertCenter
          onClose={() => display.setShowAlertCenter(false)}
          onAddAlert={() => {
            display.setShowAlertCenter(false);
            display.setShowAddAlert(true);
          }}
        />
      )}
      
      {display.showAddAlert && (
        <AddAlertDialog
          onClose={() => display.setShowAddAlert(false)}
          onSuccess={() => {
            display.setShowAddAlert(false);
            display.setShowAlertCenter(true);
          }}
        />
      )}
      
      {display.showPortfolio && portfolioManagerRef.current && (
        <PortfolioTracker
          portfolioManager={portfolioManagerRef.current}
          onClose={() => display.setShowPortfolio(false)}
          onAddPosition={() => {
            display.setShowPortfolio(false);
            display.setShowAddPosition(true);
          }}
          onEditPosition={(position) => {
            display.setShowPortfolio(false);
            display.setEditingPosition(position);
          }}
        />
      )}
      
      {display.showAddPosition && portfolioManagerRef.current && (
        <AddPositionDialog
          portfolioManager={portfolioManagerRef.current}
          onClose={() => display.setShowAddPosition(false)}
          onSuccess={() => {
            display.setShowAddPosition(false);
            display.setShowPortfolio(true);
          }}
        />
      )}
      
      {display.editingPosition && portfolioManagerRef.current && (
        <EditPositionDialog
          portfolioManager={portfolioManagerRef.current}
          position={display.editingPosition}
          onClose={() => display.setEditingPosition(null)}
          onSuccess={() => {
            display.setEditingPosition(null);
            display.setShowPortfolio(true);
          }}
        />
      )}
      
      {/* å¿«æ·é”®æç¤º */}
      <div className="shortcuts-hint">
        <div className="shortcuts-title">âŒ¨ï¸ å¿«æ·é”®</div>
        <div className="shortcuts-list">
          <div><kbd>Ctrl+Enter</kbd> å¼€å§‹ç­›é€‰</div>
          <div><kbd>Ctrl+F</kbd> ç²¾é€‰è¿‡æ»¤</div>
          <div><kbd>Ctrl+R</kbd> é‡ç½®</div>
          <div><kbd>Esc</kbd> å–æ¶ˆåˆ†æ</div>
        </div>
      </div>
    </div>
  );
}

export default App;
