# v4.12.0 Phase 2: 持仓追踪功能 - 开发计划

**开始时间**: 2026-02-07  
**预计完成**: 2026-02-08  
**状态**: 🚧 进行中

---

## 📋 功能需求

根据 Requirement 2: 持仓追踪系统，需要实现以下功能：

### 2.1 添加持仓
- 用户可以手动添加持仓记录
- 必填信息：股票代码、买入价格、买入数量、买入日期
- 系统自动计算：成本、当前市值、盈亏金额、盈亏比例
- 持仓数据保存到 localStorage

### 2.2 实时更新持仓
- 系统每30秒更新一次持仓的当前价格
- 自动重新计算盈亏金额和比例
- 显示持仓状态：盈利（绿色）、亏损（红色）、持平（灰色）

### 2.3 止损止盈提醒
- 系统根据智能交易计划自动设置止损/止盈价
- 当价格接近止损价（距离<1%）时，发送警告通知
- 当价格达到止盈价时，发送提醒通知
- 用户可以手动调整止损/止盈价

### 2.4 持仓统计
- 显示总持仓市值
- 显示总盈亏金额和比例
- 显示持仓股票数量
- 显示平均持仓天数
- 显示最佳/最差持仓表现

### 2.5 持仓风险评估
- 基于风险分散评分评估持仓风险
- 显示持仓集中度（板块、行业）
- 给出风险等级：低/中/高
- 提供优化建议

---

## 🏗️ 技术架构

### 1. 数据层（localStorage 已完成 ✅）

**文件**: `frontend/src/utils/localStorage.ts`

已实现的持仓管理函数：
- `getPositions()` - 获取所有持仓
- `savePositions()` - 保存持仓
- `addPosition()` - 添加持仓
- `removePosition()` - 删除持仓
- `updatePosition()` - 更新持仓
- `clearPositions()` - 清除所有持仓

### 2. 服务层（待实现）

#### PortfolioManager 持仓管理器

**文件**: `frontend/src/services/PortfolioManager.ts`

**功能**:
- 持仓数据管理（增删改查）
- 实时价格更新（每30秒）
- 盈亏计算
- 持仓统计
- 风险评估
- 止损止盈检查
- 与 AlertManager 集成

**主要方法**:
```typescript
class PortfolioManager {
  // 持仓管理
  addPosition(position: Position): string
  removePosition(positionId: string): void
  updatePosition(positionId: string, updates: Partial<Position>): void
  getPositions(): Position[]
  
  // 价格更新
  startPriceUpdate(): void
  stopPriceUpdate(): void
  updatePrices(): Promise<void>
  
  // 盈亏计算
  calculatePnL(position: Position, currentPrice: number): PnLResult
  getTotalPnL(): TotalPnL
  
  // 统计
  getStatistics(): PortfolioStatistics
  
  // 风险评估
  assessRisk(): RiskAssessment
  
  // 止损止盈
  checkStopLoss(): void
  checkTakeProfit(): void
}
```

### 3. 组件层（待实现）

#### PortfolioTracker 持仓追踪组件

**文件**: `frontend/src/components/PortfolioTracker.tsx`

**功能**:
- 持仓列表展示
- 实时盈亏显示
- 持仓统计面板
- 风险评估展示
- 操作按钮（编辑、删除）

**界面结构**:
```
┌─────────────────────────────────────────┐
│  📊 我的持仓                    [+ 添加] │
├─────────────────────────────────────────┤
│  统计面板                                │
│  ├─ 总市值: ¥100,000                    │
│  ├─ 总盈亏: +¥5,000 (+5.0%)             │
│  ├─ 持仓数: 3只                         │
│  └─ 风险等级: 中等                      │
├─────────────────────────────────────────┤
│  持仓列表                                │
│  ┌───────────────────────────────────┐  │
│  │ 平安银行 (000001)          [编辑]  │  │
│  │ 买入: ¥12.00 × 1000股             │  │
│  │ 当前: ¥12.50 (+4.17%)             │  │
│  │ 盈亏: +¥500                        │  │
│  │ 止损: ¥11.40 | 止盈: ¥13.20       │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ 贵州茅台 (600519)          [编辑]  │  │
│  │ ...                               │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

#### AddPositionDialog 添加持仓对话框

**文件**: `frontend/src/components/AddPositionDialog.tsx`

**功能**:
- 股票信息输入
- 买入价格和数量输入
- 买入日期选择
- 止损止盈设置（可选）
- 表单验证

**界面结构**:
```
┌─────────────────────────────────────────┐
│  添加持仓                        [×]     │
├─────────────────────────────────────────┤
│  股票信息                                │
│  ├─ 股票代码: [000001]                  │
│  ├─ 股票名称: [平安银行]                │
│  └─ 当前价格: ¥12.50                    │
├─────────────────────────────────────────┤
│  买入信息                                │
│  ├─ 买入价格: [12.00]                   │
│  ├─ 买入数量: [1000] 股                 │
│  ├─ 买入日期: [2026-02-01]              │
│  └─ 总成本: ¥12,000                     │
├─────────────────────────────────────────┤
│  止损止盈（可选）                        │
│  ├─ 止损价: [11.40] (-5%)               │
│  ├─ 止盈价: [13.20] (+10%)              │
│  └─ □ 自动创建提醒                      │
├─────────────────────────────────────────┤
│              [取消]  [添加持仓]          │
└─────────────────────────────────────────┘
```

---

## 📝 实施步骤

### Step 1: 创建 PortfolioManager 服务 ⏳

**文件**: `frontend/src/services/PortfolioManager.ts`

**任务**:
1. 定义 TypeScript 接口
2. 实现持仓管理方法
3. 实现价格更新机制
4. 实现盈亏计算
5. 实现统计功能
6. 实现风险评估
7. 集成 AlertManager

**预计时间**: 2小时

### Step 2: 创建 PortfolioTracker 组件 ⏳

**文件**: `frontend/src/components/PortfolioTracker.tsx`

**任务**:
1. 创建组件结构
2. 实现统计面板
3. 实现持仓列表
4. 实现实时更新
5. 实现操作按钮
6. 添加样式

**预计时间**: 2小时

### Step 3: 创建 AddPositionDialog 组件 ⏳

**文件**: `frontend/src/components/AddPositionDialog.tsx`

**任务**:
1. 创建对话框结构
2. 实现表单输入
3. 实现表单验证
4. 实现自动计算
5. 集成 PortfolioManager
6. 添加样式

**预计时间**: 1.5小时

### Step 4: 集成到主应用 ⏳

**文件**: `frontend/src/App.tsx`

**任务**:
1. 导入 PortfolioManager 和组件
2. 初始化 PortfolioManager
3. 添加"我的持仓"按钮
4. 渲染 PortfolioTracker 组件
5. 测试功能

**预计时间**: 0.5小时

### Step 5: 测试和优化 ⏳

**任务**:
1. 功能测试
2. 性能优化
3. UI/UX 优化
4. 文档更新

**预计时间**: 1小时

---

## 🎯 验收标准

### 功能验收

- [ ] 可以添加持仓记录
- [ ] 可以查看持仓列表
- [ ] 可以编辑持仓信息
- [ ] 可以删除持仓
- [ ] 实时更新价格和盈亏
- [ ] 显示持仓统计
- [ ] 显示风险评估
- [ ] 止损止盈提醒正常工作

### 性能验收

- [ ] 价格更新延迟 < 30秒
- [ ] 盈亏计算准确
- [ ] 界面响应流畅
- [ ] 无内存泄漏

### UI/UX 验收

- [ ] 界面清晰易懂
- [ ] 操作简单直观
- [ ] 颜色区分明显（盈利绿色、亏损红色）
- [ ] 响应式设计

---

## 📊 技术细节

### 盈亏计算公式

```typescript
// 成本
cost = buyPrice × quantity

// 当前市值
currentValue = currentPrice × quantity

// 盈亏金额
pnlAmount = currentValue - cost

// 盈亏比例
pnlPercent = (pnlAmount / cost) × 100

// 持仓天数
holdDays = Math.floor((now - buyDate) / (1000 * 60 * 60 * 24))
```

### 风险评估算法

```typescript
// 持仓集中度
concentration = maxPositionValue / totalValue

// 风险等级
if (concentration > 0.5) riskLevel = 'high'
else if (concentration > 0.3) riskLevel = 'medium'
else riskLevel = 'low'

// 板块分散度
boardDiversity = uniqueBoards / totalPositions

// 行业分散度
industryDiversity = uniqueIndustries / totalPositions
```

### 止损止盈检查

```typescript
// 止损检查
if (currentPrice <= stopLoss) {
  triggerAlert('stop_loss', position)
}

// 接近止损警告
if (currentPrice <= stopLoss * 1.01) {
  triggerAlert('approaching_stop', position)
}

// 止盈检查
if (currentPrice >= takeProfit) {
  triggerAlert('take_profit', position)
}
```

---

## 🔗 与现有功能集成

### 1. 与 AlertManager 集成

- 持仓添加时自动创建止损止盈提醒
- 价格更新时检查止损止盈条件
- 触发提醒时调用 AlertManager

### 2. 与智能交易计划集成

- 从交易计划获取建议的止损止盈价
- 显示交易计划的风险收益比
- 关联交易计划和持仓

### 3. 与风险分散评分集成

- 使用风险分散算法评估持仓风险
- 显示持仓的板块和行业分布
- 提供优化建议

---

## 📚 参考文档

- Phase 1 完成报告
- smart-trading-alerts requirements.md
- localStorage 工具文档
- AlertManager API 文档

---

**创建时间**: 2026-02-07  
**作者**: AI Assistant
